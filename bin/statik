#!/usr/bin/perl

use strict;
use warnings;
use Getopt::Long::Descriptive;
use YAML;

use FindBin qw($Bin);
use lib "$Bin/../lib";
use Statik::Config;
use Statik::PluginList;
#use Statik::Generator;

$|++;

my ($opt, $usage) = describe_options(
  '%c %o',
  [ 'config|c=s'    => '<config_file> - statik config file' ],
  [ 'verbose|v+'    => 'print more verbose output' ],
  [ 'help|h|?'      => 'print usage message and exit' ],
);
print($usage->text), exit if $opt->help;
print($usage->text), exit if @ARGV;

# Load config file
my $config = Statik::Config->new(file => $opt->config);
print Dump $config if $opt->verbose >= 2;

# Load plugins
my $plugins = Statik::PluginList->new(config => $config);
print Dump $plugins if $opt->verbose >= 2;

# Load entries from post_dir
print "+ Loading entries from $config->{post_dir}\n" if $opt->verbose;
my $entries = $plugins->first('entries');
my ($files, $updates) = $entries->entries(config => $config);
printf "+ Found %d post files, %d updated\n", 
  scalar keys %$files, scalar keys %$updates if $opt->verbose;

__END__

# Generate static pages
my $gen = Statik::Generator->new(
  config    => $config, 
  plugins   => $plugins,
  files     => $files,
);
$gen->generate_all(indexes => $indexes);

